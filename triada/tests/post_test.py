import datetime
from random import randint

import pytest
from unittest.mock import patch, call, ANY

from sqlalchemy import delete
from sqlmodel import select
from triada.handlers.post import handle_post
from triada.main import post_to_battles
from triada.schemas.table_models import Battles, Judges, BattlesPlayers, Users


@pytest.mark.asyncio
async def post_test(post: dict, called: bool = True, mock_vk_client = None):
    with patch('httpx.AsyncClient', return_value=mock_vk_client):
        response = await handle_post(post)

    if called:
        mock_vk_client.__aenter__.return_value.post.assert_called()
        call_args = mock_vk_client.__aenter__.return_value.post.call_args_list
        return call_args
    else:
        mock_vk_client.__aenter__.return_value.post.assert_not_called()
        return response


class TestPost:
    @pytest.mark.asyncio
    async def test_post(self, mock_vk_client_factory, db_session):
        db_session.add(Users(user_id=456507851,
                             technical_wins=0,
                             technical_losses=0,
                             fragments_of_victories=0,
                             skill_rating=0,
                             wins=0,
                             user_name='Gene Takovic',
                             losses=0,
                             mmr=100,
                             fragments_of_greatness=0))
        await db_session.commit()

        post = await post_test({
            "text": """üó° ‚Ä¢ –¢–µ—Å—Å–µ—Ä–∞–∫—Ç ‚Ä¢ üó°
üèπ ‚Ä¢ –ü–¢–ë: –ü–æ–µ–¥–∏–Ω–æ–∫ ‚Ä¢ üõ°

„Äå [id456507851|–î–µ–π–¥–∞—Ä–∞] [VS] [id736580398|–ö–∏–ª–ª–µ—Ä –ë–∏] „Äç

I. üë§ ‚Äî –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∏–≥—Ä—ã ‚Äî üë•:

„Äå [id456507851|Gene Takovic] –≤ —Ä–æ–ª–∏ ¬´–î–µ–π–¥–∞—Ä–∞¬ª –∏–∑ ¬´–ù–∞—Ä—É—Ç–æ¬ª „Äç
„Äå [id736580398|Roman Borsalinovich] –≤ —Ä–æ–ª–∏ ¬´–ö–∏–ª–ª–µ—Ä –ë–∏¬ª –∏–∑ ¬´–ù–∞—Ä—É—Ç–æ¬ª „Äç

II. üÉè ‚Äî –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã ‚Äî ‚ô†:

„Äå [id456507851|–î–µ–π–¥–∞—Ä–∞]: –ü–∏–∫ —Å–∏–ª –ø—Ä–∏ –∂–∏–∑–Ω–∏. –ë–µ–∑ –°0.
–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ: –ö–∞–Ω–æ–Ω–∏—á–Ω–æ–µ. –ë–µ–∑ —Ä–∞–Ω–µ–µ –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–π –≤–∑—Ä—ã–≤—á–∞—Ç–∫–∏ „Äç

„Äå [id736580398|–ö–∏–ª–ª–µ—Ä –ë–∏] ‚Äî –ü–∏–∫ —Å–∏–ª –Ω–∞ –º–æ–º–µ–Ω—Ç –ß–í–í–®. –í –±–∞–∑–æ–≤–æ–π —Ñ–æ—Ä–º–µ –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –≤ 1,5 —Ä–∞–∑–∞, –≤ –ø–æ–∫—Ä–æ–≤–µ —á–∞–∫—Ä—ã –ë–∏–¥–∂—É –≤ 2 —Ä–∞–∑–∞. –ë–∏–¥–∂—É–¥–∞–º–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ü–∏–∏ –ì—å—é–∫–∏, —Å 3 –∫—Ä—É–≥–∞ –ø–æ—Å—Ç–æ–≤.
–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ: –ö–∞–Ω–æ–Ω–∏—á–Ω–æ–µ „Äç

III. üìù ‚Äî –¢–æ–Ω–∫–æ—Å—Ç–∏ –∏ –¥–µ—Ç–∞–ª–∏ ‚Äî üìú:

‚Ä¢ –°–∫—Ä—ã—Ç—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: –†–∞–∑—Ä–µ—à–µ–Ω—ã ‚Ä¢
‚Ä¢ –†–∞–∑–≤–∏—Ç–æ—Å—Ç—å –Ω–∞–≤—ã–∫–æ–≤: –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Ä¢
‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –∫–∞—á–µ—Å—Ç–≤–æ —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–∏—Ä–∞–≤–Ω–µ–Ω–æ –∏ —Ä–∞–≤–Ω–æ 100%. –õ—é–±–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∏—Å—Ö–æ–¥–∏—Ç –∏–∑ —Ä–∞–∑–Ω–∏—Ü—ã —ç–Ω–µ—Ä–≥–∏–π. (–°—Ç—Ä–µ–ª–∞ —Å 10% —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–æ–±–∏–≤–∞–µ—Ç —â–∏—Ç —Å 9% —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Ç.–¥.). –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ 40 –º–µ—Ç—Ä–æ–≤, —Ç–æ—á–∫—É –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–≤—ã–π —Ö–æ–¥—è—â–∏–π ‚Ä¢

IV. üèõ ‚Äî –ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è ‚Äî üåê:

‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏: –ü–æ–¥ –ø–æ–∫—Ä–æ–≤–æ–º –Ω–æ—á–∏, –∫–æ–≥–¥–∞ –Ω–µ–±–æ —É—Å—ã–ø–∞–Ω–æ –±–µ—Å—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ –∑–≤—ë–∑–¥–∞–º–∏, –º–µ–∂ –≥–æ—Ä–Ω—ã—Ö –≤–µ—Ä—à–∏–Ω —Å—Ç—Ä—É–∏—Ç—Å—è —Å–µ—Ä–µ–±—Ä—è–Ω–∞—è –ª–µ–Ω—Ç–∞ —Ä–µ–∫–∏. –ï—ë –≤–æ–¥—ã, –∫–∞–∫ –∂–∏–≤—ã–µ, —Å–∫–æ–ª—å–∑—è—Ç –º–µ–∂ –¥—Ä–µ–≤–Ω–∏—Ö –∫–∞–º–Ω–µ–π, –æ–±—Ç–æ—á–µ–Ω–Ω—ã—Ö –≤–µ–∫–∞–º–∏, –æ—Ç—Ä–∞–∂–∞—è —Ö–æ–ª–æ–¥–Ω—ã–π —Å–≤–µ—Ç –∑–≤—ë–∑–¥ –∏ —Å–æ–∑–¥–∞–≤–∞—è –∏–ª–ª—é–∑–∏—é –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è.
–¢—ë–º–Ω—ã–µ —Å–∏–ª—É—ç—Ç—ã –≥–æ—Ä –≤–æ–∑–≤—ã—à–∞—é—Ç—Å—è –Ω–∞–¥ –¥–æ–ª–∏–Ω–æ–π, –∏—Ö –≥—Ä–æ–∑–Ω—ã–µ –ø–∏–∫–∏ —Ç—è–Ω—É—Ç—Å—è –≤–≤—ã—Å—å, —Å–∫—Ä—ã–≤–∞—è—Å—å –≤ —Ç—É–º–∞–Ω–Ω–æ–π –¥—ã–º–∫–µ. –ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π —Å–≤–µ—Ç –ú–ª–µ—á–Ω–æ–≥–æ –ü—É—Ç–∏ –º—è–≥–∫–æ –æ–∑–∞—Ä—è–µ—Ç —Å–∫–ª–æ–Ω—ã, –ø—Ä–µ–≤—Ä–∞—â–∞—è –∏—Ö –≤ —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–ª–∞–¥–µ–Ω–∏—è –¥—Ä–µ–≤–Ω–∏—Ö –¥—É—Ö–æ–≤. –¢—Ä–∞–≤–∞ –∏ –º–æ—Ö, —É–∫—É—Ç–∞–Ω–Ω—ã–µ –Ω–æ—á–Ω–æ–π –ø—Ä–æ—Ö–ª–∞–¥–æ–π, –¥—Ä–µ–º–ª—é—Ç, —Å–ª—É—à–∞—è –≤–µ—á–Ω—É—é –ø–µ—Å–Ω—å –≥–æ—Ä–Ω–æ–≥–æ —Ä—É—á—å—è.
–ö–∞–∂–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ –º–µ—Å—Ç–æ ‚Äì –≥—Ä–∞–Ω–∏—Ü–∞ –º–∏—Ä–æ–≤. –ó–¥–µ—Å—å, –≤ —ç—Ç–æ–π –¥–æ–ª–∏–Ω–µ, –≤—Ä–µ–º—è –∑–∞–º–µ–¥–ª—è–µ—Ç —Å–≤–æ–π –±–µ–≥, —Ä–∞—Å—Ç–≤–æ—Ä—è—è—Å—å –≤ —à—ë–ø–æ—Ç–µ –≤–µ—Ç—Ä–∞ –∏ –∂—É—Ä—á–∞–Ω–∏–∏ –≤–æ–¥—ã. –ú–æ–∂–µ—Ç –±—ã—Ç—å, —Å—Ç–æ–∏—Ç –ª–∏—à—å –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç—å –≥–ª–∞–∑–∞, –∏ –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç —Ñ–∏–≥—É—Ä–∞ —Å—Ç—Ä–∞–Ω–Ω–∏–∫–∞, –∏–¥—É—â–µ–≥–æ –ø–æ –∫–∞–º–Ω—è–º, –∏–ª–∏ —Ç–µ–Ω—å –¥—Ä–∞–∫–æ–Ω–∞, –º–µ–ª—å–∫–Ω—É–≤—à–∞—è –Ω–∞ —Ñ–æ–Ω–µ –¥–∞–ª—ë–∫–∏—Ö –≥–æ—Ä ‚Ä¢
‚Ä¢ –ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è: 15:00, +15¬∞, –≤–µ—Ç–µ—Ä 5 –º/—Å ‚Ä¢

V. ‚öô ‚Äî –£—Å–ª–æ–≤–∏—è —Å—Ä–∞–∂–µ–Ω–∏—è ‚Äî üîß :

‚Ä¢ –≠—Ä—É–¥–∏—Ü–∏—è: –ö–∞–Ω–æ–Ω–∏—á–Ω–∞—è ‚Ä¢
‚Ä¢ –¢–∏–ø –±–∏—Ç–≤—ã: –ù–∞—Å–º–µ—Ä—Ç—å ‚Ä¢
‚Ä¢ –£—Å–ª–æ–≤–∏—è –ø–æ–±–µ–¥—ã: –£–±–∏–π—Å—Ç–≤–æ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞ ‚Ä¢
‚Ä¢ –í—Ä–µ–º—è –Ω–∞ –ø–æ—Å—Ç: 24 —á–∞—Å–∞ ‚Ä¢
‚Ä¢ –ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π: [id456507851|–î–µ–π–¥–∞—Ä–∞] -> [id736580398|–ö–∏–ª–ª–µ—Ä –ë–∏] ‚Ä¢""",
            "id": 124 # –ù–µ –º–µ–Ω—è—Ç—å
        }, called=True, mock_vk_client=mock_vk_client_factory())




        assert post == [call('https://api.vk.com/method/messages.send', params={
            'access_token': ANY,
            'peer_id': 2000000002,
            'message': '–ü–æ—Å—Ç –ø–æ–¥ —Å—É–¥–µ–π—Å—Ç–≤–æ–º @id2(—ç—Ç–æ–≥–æ —Å—É–¥—å–∏)',
            'random_id': ANY, 'v': '5.199', 'attachment': None})]
        assert ((await db_session.exec(select(Battles).where(Battles.link == 124))).first() ==
                Battles(date=ANY, judge_id=2, time_out=datetime.timedelta(days=1), link=ANY, turn=0, status='active'))
        assert ((await db_session.exec(select(BattlesPlayers).where(BattlesPlayers.link == 124))).all() ==
                [BattlesPlayers(id=ANY,
                                turn=1,
                                universe='–ù–∞—Ä—É—Ç–æ',
                                time_out=None,
                                hidden_action=None,
                                user_id=736580398,
                                character='–ö–∏–ª–ª–µ—Ä –ë–∏',
                                result=None,
                                user_name='Roman Borsalinovich',
                                link=124),
                BattlesPlayers(id=ANY,
                               turn=0,
                               universe='–ù–∞—Ä—É—Ç–æ',
                               time_out=ANY,
                               hidden_action=None,
                               user_id=456507851,
                               character='–î–µ–π–¥–∞—Ä–∞',
                               result=None,
                               user_name='Gene Takovic',
                               link=124)])
        assert ((await db_session.exec(select(Users).
                                      where((Users.user_id == 736580398) | (Users.user_id == 456507851)))).all() ==
                [Users(user_id=456507851,
                       technical_wins=0,
                       technical_losses=0,
                       fragments_of_victories=0,
                       skill_rating=0,
                       wins=0,
                       user_name='Gene Takovic',
                       losses=0,
                       mmr=100,
                       fragments_of_greatness=0),
                 Users(user_id=736580398,
                       technical_wins=0,
                       technical_losses=0,
                       fragments_of_victories=0,
                       skill_rating=0,
                       wins=0,
                       user_name='Roman Borsalinovich',
                       losses=0,
                       mmr=100,
                       fragments_of_greatness=0)])
